services:
  # -------------------------
  # One-time Maven installer (builds parent + common-lib into shared m2-cache)
  # -------------------------
  maven-install:
    image: maven:3.9-eclipse-temurin-21
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    command: ["mvn", "-q", "-DskipTests", "install"]
    restart: "no"

  # -------- Infra --------
  mysql:
    image: mysql:8.0
    ports:
      - "3307:3306"   # host:container (change back to 3306 if nothing else uses it)
    environment:
      MYSQL_DATABASE: userdb
      MYSQL_ROOT_PASSWORD: root
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -proot --silent"]
      interval: 5s
      timeout: 3s
      retries: 40

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    depends_on:
      - zookeeper
    ports:
      - "29092:29092" # host access (containers use kafka:9092; no need to publish 9092)
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"

      # internal (containers) + external (your laptop) listeners
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  # -------- Platform services --------
  service-registry:
    build:
      context: ./service-registry
      target: dev
    ports:
      - "8761:8761"
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    working_dir: /workspace/service-registry
    depends_on:
      maven-install:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8761/ >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40

  config-server:
    build:
      context: ./config-server
      target: dev
    ports:
      - "8888:8888"
    volumes:
      - ./:/workspace
      - ./config-repo:/config-repo:ro
      - m2-cache:/root/.m2
    working_dir: /workspace/config-server
    environment:
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://service-registry:8761/eureka"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      service-registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8888/actuator/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40

  api-gateway:
    build:
      context: ./api-gateway
      target: dev
    ports:
      - "8080:8080"
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    working_dir: /workspace/api-gateway
    environment:
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8888"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://service-registry:8761/eureka"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS: "kafka:9092"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy

  user-service:
    build:
      context: ./user-service
      target: dev
    ports:
      - "8091:8091"
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    working_dir: /workspace/user-service
    environment:
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8888"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://service-registry:8761/eureka"
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/userdb?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
      SPRING_DATASOURCE_USERNAME: "root"
      SPRING_DATASOURCE_PASSWORD: "root"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS: "kafka:9092"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      mysql:
        condition: service_healthy

  inventory-service:
    build:
      context: ./inventory-service
      target: dev
    ports:
      - "8092:8092"
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    working_dir: /workspace/inventory-service
    environment:
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8888"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://service-registry:8761/eureka"
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/userdb?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
      SPRING_DATASOURCE_USERNAME: "root"
      SPRING_DATASOURCE_PASSWORD: "root"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      mysql:
        condition: service_healthy

  qr-service:
    build:
      context: ./qr-service
      target: dev
    ports:
      - "8093:8093"
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    working_dir: /workspace/qr-service
    environment:
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8888"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://service-registry:8761/eureka"
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/userdb?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
      SPRING_DATASOURCE_USERNAME: "root"
      SPRING_DATASOURCE_PASSWORD: "root"
      SPRING_KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      SPRING_CLOUD_STREAM_KAFKA_BINDER_BROKERS: "kafka:9092"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      mysql:
        condition: service_healthy

  auth-service:
    build:
      context: ./auth-service
      target: dev
    ports:
      - "8090:8090"
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    working_dir: /workspace/auth-service
    environment:
      SPRING_CLOUD_CONFIG_URI: "http://config-server:8888"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://service-registry:8761/eureka"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy

  # -------- Watching / GUIs --------
  dozzle:
    image: amir20/dozzle:latest
    ports:
      - "9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      DOZZLE_TAILSIZE: 300
    restart: unless-stopped

  portainer:
    image: portainer/portainer-ce:latest
    ports:
      - "9443:9443"  # HTTPS UI
      - "9000:9000"  # HTTP UI (optional)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    restart: unless-stopped

volumes:
  m2-cache:
  mysql-data:
  portainer-data:
