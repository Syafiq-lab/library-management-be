x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "5"

x-spring-common-env: &spring-common-env
  SPRING_PROFILES_ACTIVE: docker
  CONFIG_SERVER_URL: http://config-server:8888
  EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://service-registry:8761/eureka/

services:
  # -------------------------
  # One-time Maven installer
  # -------------------------
  maven-install:
    image: maven:3.9-eclipse-temurin-21
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    command: ["mvn", "-q", "-DskipTests", "install"]
    restart: "no"
    logging: *default-logging

  # -------- Infra --------
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: userdb
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot --silent"]
      interval: 5s
      timeout: 3s
      retries: 40
    logging: *default-logging

  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    logging: *default-logging

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    depends_on:
      - zookeeper
    ports:
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server 127.0.0.1:9092 >/dev/null 2>&1"]
      interval: 5s
      timeout: 5s
      retries: 40
    logging: *default-logging

  # -------- Platform services --------
  service-registry:
    build:
      context: ./service-registry
      target: dev
    working_dir: /workspace/service-registry
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    ports:
      - "8761:8761"
    depends_on:
      maven-install:
        condition: service_completed_successfully
    environment:
      <<: *spring-common-env
      SERVER_PORT: "8761"
      EUREKA_CLIENT_REGISTER_WITH_EUREKA: "false"
      EUREKA_CLIENT_FETCH_REGISTRY: "false"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8761/actuator/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60
    logging: *default-logging

  config-server:
    build:
      context: ./config-server
      target: dev
    working_dir: /workspace/config-server
    volumes:
      - ./:/workspace
      - ./config-repo:/config-repo:ro
      - m2-cache:/root/.m2
    ports:
      - "8888:8888"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      service-registry:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: native,docker
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: file:/config-repo
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://service-registry:8761/eureka/
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8888/actuator/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60
    logging: *default-logging

  # -------- Microservices --------
  api-gateway:
    build:
      context: ./api-gateway
      target: dev
    working_dir: /workspace/api-gateway
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    ports:
      - "8080:8080"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    environment:
      <<: *spring-common-env

      # ====== HOT RELOAD SETTINGS (added) ======
      # Allow DevTools detection inside container
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "false"
      JAVA_TOOL_OPTIONS: >-
        -Dspring.devtools.restart.poll-interval=2s
        -Dspring.devtools.restart.quiet-period=1s

    # Important: run via maven so DevTools works
    command: ["mvn", "-q", "-DskipTests", "spring-boot:run"]

    logging: *default-logging

  auth-service:
    build:
      context: ./auth-service
      target: dev
    working_dir: /workspace/auth-service
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    ports:
      - "8090:8090"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      kafka:
        condition: service_healthy
      mysql:
        condition: service_healthy

    environment:
      <<: *spring-common-env

      # ====== HOT RELOAD SETTINGS (added) ======
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "false"
      JAVA_TOOL_OPTIONS: >-
        -Dspring.devtools.restart.poll-interval=2s
        -Dspring.devtools.restart.quiet-period=1s

    # Important: run via maven so DevTools works
    command: ["mvn", "-q", "-DskipTests", "spring-boot:run"]

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8090/actuator/health >/dev/null || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60

    logging: *default-logging

  user-service:
    build:
      context: ./user-service
      target: dev
    working_dir: /workspace/user-service
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    ports:
      - "8091:8091"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      <<: *spring-common-env

      # ====== HOT RELOAD SETTINGS (added) ======
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "false"
      JAVA_TOOL_OPTIONS: >-
        -Dspring.devtools.restart.poll-interval=2s
        -Dspring.devtools.restart.quiet-period=1s

    command: ["mvn", "-q", "-DskipTests", "spring-boot:run"]

    logging: *default-logging

  inventory-service:
    build:
      context: ./inventory-service
      target: dev
    working_dir: /workspace/inventory-service
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    ports:
      - "8092:8092"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      <<: *spring-common-env

      # ====== HOT RELOAD SETTINGS (added) ======
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "false"
      JAVA_TOOL_OPTIONS: >-
        -Dspring.devtools.restart.poll-interval=2s
        -Dspring.devtools.restart.quiet-period=1s

    command: ["mvn", "-q", "-DskipTests", "spring-boot:run"]

    logging: *default-logging

  qr-service:
    build:
      context: ./qr-service
      target: dev
    working_dir: /workspace/qr-service
    volumes:
      - ./:/workspace
      - m2-cache:/root/.m2
    ports:
      - "8093:8093"
    depends_on:
      maven-install:
        condition: service_completed_successfully
      config-server:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      <<: *spring-common-env

      # ====== HOT RELOAD SETTINGS (added) ======
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_LIVERELOAD_ENABLED: "false"
      JAVA_TOOL_OPTIONS: >-
        -Dspring.devtools.restart.poll-interval=2s
        -Dspring.devtools.restart.quiet-period=1s

    command: ["mvn", "-q", "-DskipTests", "spring-boot:run"]

    logging: *default-logging

  # -------- Observability / UI --------
  dozzle:
    image: amir20/dozzle:latest
    ports:
      - "9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      DOZZLE_TAILSIZE: 300
    restart: unless-stopped
    logging: *default-logging

  portainer:
    image: portainer/portainer-ce:latest
    ports:
      - "9443:9443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
      - ./portainer_admin_password:/run/secrets/portainer_admin_password:ro
    command: ["--admin-password-file", "/run/secrets/portainer_admin_password"]
    restart: unless-stopped
    logging: *default-logging

volumes:
  m2-cache:
  mysql-data:
  portainer-data:
